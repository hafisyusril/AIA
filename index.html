<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main Container</title>

    <!-- GLOBAL CSS for all pages -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="health-check/style.css" />
    <link rel="stylesheet" href="reward-redeem/style.css" />
    <link rel="stylesheet" href="vitality/style.css"/>
    <link rel="stylesheet" href="outro/style.css"/>
  </head>
  <body>
    <!-- Container for all pages -->
    <div id="container"></div>

   <!-- MAIN SCROLL SCRIPT -->
<script>
  const pagesHTML = [
    "intro/intro.html",
    "walker.html",
    "gym-visit/gym-visit.html",
    "weekly-challenge/weekly-challenge.html",
    "tiering/tiering.html",
    "health-check/health-check.html",
    "reward-redeem/reward-redeem.html",
    "vitality/vitality.html",
    "outro/outro.html"
  ];
  const container = document.getElementById("container");

  async function loadPages() {
    for (const page of pagesHTML) {
      try {
        const res = await fetch(page);
        const html = await res.text();
        const div = document.createElement("div");
        div.classList.add("page");
        div.innerHTML = html;
        container.appendChild(div);
        
        // Execute scripts manually since innerHTML doesn't execute them
        const scripts = div.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      } catch (err) {
        console.error("Failed to load page", page, err);
      }
    }
    await initPageScripts();
    initScroll();
  }

  // TikTok-style scroll
  function initScroll() {
    const pageElements = document.querySelectorAll(".page");
    let currentPage = 0;
    let isScrolling = false;

    pageElements[0].classList.add("active");
    setTimeout(() => {
      triggerPageAnimations(pageElements[0]);
    }, 200);

    function triggerPageAnimations(pageElement) {
      const pageIndex = Array.from(pageElements).indexOf(pageElement);

      // Trigger walker animation (page index 1)
      if (pageIndex === 1 && typeof window.initWalkerAnimation === 'function') {
        window.initWalkerAnimation();
      }

      const event = new CustomEvent("pageActivated", {
        detail: { pageIndex },
      });
      pageElement.dispatchEvent(event);

      const animatedElements = pageElement.querySelectorAll(
        '[style*="animation"]'
      );
      animatedElements.forEach((el) => {
        const animation = el.style.animation;
        el.style.animation = "none";
        setTimeout(() => {
          el.style.animation = animation;
        }, 10);
      });
    }

    function goToPage(index) {
      if (index < 0 || index >= pageElements.length) return;
      isScrolling = true;

      pageElements.forEach((p) => p.classList.remove("active"));

      currentPage = index;
      pageElements[currentPage].classList.add("active");
      pageElements[currentPage].scrollIntoView({ behavior: "smooth" });

      setTimeout(() => {
        triggerPageAnimations(pageElements[currentPage]);
      }, 100);

      setTimeout(() => (isScrolling = false), 700);
    }

    window.addEventListener("wheel", (e) => {
      if (isScrolling) return;
      if (e.deltaY > 0) goToPage(currentPage + 1);
      if (e.deltaY < 0) goToPage(currentPage - 1);
    });

    let touchStartY = 0;
    window.addEventListener("touchstart", (e) => {
      touchStartY = e.touches[0].clientY;
    });
    window.addEventListener("touchend", (e) => {
      const touchEndY = e.changedTouches[0].clientY;
      if (isScrolling) return;
      if (touchStartY - touchEndY > 50) goToPage(currentPage + 1);
      if (touchEndY - touchStartY > 50) goToPage(currentPage - 1);
    });
  }

  function initPageScripts() {
    return new Promise((resolve) => {
      let scriptsLoaded = 0;
      const totalScripts = 2;

      function onScriptLoad() {
        scriptsLoaded++;
        if (scriptsLoaded === totalScripts) {
          setTimeout(() => resolve(), 100);
        }
      }

      const healthScript = document.createElement("script");
      healthScript.src = "health-check/script.js";
      healthScript.onload = onScriptLoad;
      document.body.appendChild(healthScript);

      const rewardScript = document.createElement("script");
      rewardScript.src = "reward-redeem/script.js";
      rewardScript.onload = onScriptLoad;
      document.body.appendChild(rewardScript);
    });
  }

  loadPages();
</script>
  </body>
</html>
